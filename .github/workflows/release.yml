name: Release

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v1.0.0)"
        required: true

env:
  CARGO_TERM_COLOR: always

jobs:
  # Quality gates - all must pass before release
  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - run: cargo clippy --all-targets --all-features -- -D warnings

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo test --all-features --workspace

  # Publish to crates.io (tags only)
  publish-crates:
    name: Publish to crates.io
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [fmt, clippy, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      
      - name: Set version from tag
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "Publishing version: $VERSION (replacing 0.0.0-source sentinel)"
          sed -i 's/0\.0\.0-source/'"$VERSION"'/g' Cargo.toml
          echo "--- Updated Cargo.toml versions ---"
          grep 'version' Cargo.toml | head -20
      
      - name: Publish lnc-core
        run: cargo publish -p lnc-core --allow-dirty --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: true
        
      - name: Wait for crates.io indexing
        run: sleep 30
        
      - name: Publish lnc-metrics
        run: cargo publish -p lnc-metrics --allow-dirty --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: true
        
      - name: Wait for crates.io indexing
        run: sleep 30
        
      - name: Publish lnc-network
        run: cargo publish -p lnc-network --allow-dirty --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        continue-on-error: true
        
      - name: Wait for crates.io indexing
        run: sleep 30
        
      - name: Publish lnc-client
        run: cargo publish -p lnc-client --allow-dirty --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # Build for Linux x86_64 (tags only)
  build-linux-x86_64:
    name: Build Linux x86_64
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [fmt, clippy, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu
      - uses: Swatinem/rust-cache@v2
      
      - name: Set version from tag
        run: sed -i 's/0\.0\.0-source/'"${GITHUB_REF_NAME#v}"'/g' Cargo.toml
      
      - name: Build
        run: cargo build --release --target x86_64-unknown-linux-gnu
        
      - name: Package
        run: |
          VERSION=${{ github.ref_name }}
          mkdir -p dist
          cp target/x86_64-unknown-linux-gnu/release/lance dist/
          cp target/x86_64-unknown-linux-gnu/release/lnc dist/
          cp LICENSE dist/
          cd dist
          tar -czvf lance-${VERSION}-linux-x86_64.tar.gz lance lnc LICENSE
          rm lance lnc LICENSE
          
      - uses: actions/upload-artifact@v4
        with:
          name: lance-linux-x86_64
          path: dist/*.tar.gz
          compression-level: 0

  # Build for Linux ARM64 (tags only)
  build-linux-aarch64:
    name: Build Linux ARM64
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [fmt, clippy, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu
      - uses: Swatinem/rust-cache@v2
      
      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
          
      - name: Set version from tag
        run: sed -i 's/0\.0\.0-source/'"${GITHUB_REF_NAME#v}"'/g' Cargo.toml
      
      - name: Build
        run: |
          export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
          cargo build --release --target aarch64-unknown-linux-gnu
        
      - name: Package
        run: |
          VERSION=${{ github.ref_name }}
          mkdir -p dist
          cp target/aarch64-unknown-linux-gnu/release/lance dist/
          cp target/aarch64-unknown-linux-gnu/release/lnc dist/
          cp LICENSE dist/
          cd dist
          tar -czvf lance-${VERSION}-linux-aarch64.tar.gz lance lnc LICENSE
          rm lance lnc LICENSE
          
      - uses: actions/upload-artifact@v4
        with:
          name: lance-linux-aarch64
          path: dist/*.tar.gz
          compression-level: 0

  # Build for macOS x86_64 (tags only)
  build-macos-x86_64:
    name: Build macOS x86_64
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [fmt, clippy, test]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin
      - uses: Swatinem/rust-cache@v2
      
      - name: Set version from tag
        run: sed -i '' 's/0\.0\.0-source/'"${GITHUB_REF_NAME#v}"'/g' Cargo.toml
      
      - name: Build
        run: cargo build --release --target x86_64-apple-darwin
        
      - name: Package
        run: |
          VERSION=${{ github.ref_name }}
          mkdir -p dist
          cp target/x86_64-apple-darwin/release/lance dist/
          cp target/x86_64-apple-darwin/release/lnc dist/
          cp LICENSE dist/
          cd dist
          tar -czvf lance-${VERSION}-macos-x86_64.tar.gz lance lnc LICENSE
          rm lance lnc LICENSE
          
      - uses: actions/upload-artifact@v4
        with:
          name: lance-macos-x86_64
          path: dist/*.tar.gz
          compression-level: 0

  # Build for macOS ARM64 (tags only)
  build-macos-aarch64:
    name: Build macOS ARM64
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [fmt, clippy, test]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin
      - uses: Swatinem/rust-cache@v2
      
      - name: Set version from tag
        run: sed -i '' 's/0\.0\.0-source/'"${GITHUB_REF_NAME#v}"'/g' Cargo.toml
      
      - name: Build
        run: cargo build --release --target aarch64-apple-darwin
        
      - name: Package
        run: |
          VERSION=${{ github.ref_name }}
          mkdir -p dist
          cp target/aarch64-apple-darwin/release/lance dist/
          cp target/aarch64-apple-darwin/release/lnc dist/
          cp LICENSE dist/
          cd dist
          tar -czvf lance-${VERSION}-macos-aarch64.tar.gz lance lnc LICENSE
          rm lance lnc LICENSE
          
      - uses: actions/upload-artifact@v4
        with:
          name: lance-macos-aarch64
          path: dist/*.tar.gz
          compression-level: 0

  # Build and push Docker image to DockerHub with attestations
  docker:
    name: Docker Build & Push
    needs: [fmt, clippy, test]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      attestations: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: Set version from tag
        run: sed -i 's/0\.0\.0-source/'"${GITHUB_REF_NAME#v}"'/g' Cargo.toml
      
      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: nitecon/lance
          tags: |
            type=semver,pattern={{version}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=semver,pattern={{major}}.{{minor}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=semver,pattern={{major}},enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=raw,value=latest,enable=${{ github.ref_name == 'main' }}
            
      - name: Build and push with attestations
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          sbom: true
          provenance: mode=max

  # Create GitHub Release (tags only)
  release:
    name: Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs:
      - build-linux-x86_64
      - build-linux-aarch64
      - build-macos-x86_64
      - build-macos-aarch64
      - docker
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: lance-*
          path: artifacts
          
      - name: Prepare release assets
        run: |
          VERSION=${{ github.ref_name }}
          mkdir -p release
          cp artifacts/lance-linux-x86_64/*.tar.gz release/
          cp artifacts/lance-linux-aarch64/*.tar.gz release/
          cp artifacts/lance-macos-x86_64/*.tar.gz release/
          cp artifacts/lance-macos-aarch64/*.tar.gz release/
          
      - name: Generate checksums
        run: |
          cd release
          sha256sum *.tar.gz > SHA256SUMS.txt
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: LANCE ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-rc') }}
          generate_release_notes: true
          files: |
            release/*.tar.gz
            release/SHA256SUMS.txt
          body: |
            ## LANCE ${{ github.ref_name }}
            
            High-performance, non-blocking stream engine for 100Gbps ingestion.
            
            ### Downloads
            
            #### Server + Client Packages
            
            Full distribution containing both the `lance` server and `lnc` CLI client:
            
            | Platform | Architecture | File |
            |----------|--------------|------|
            | Linux | x86_64 | `lance-${{ github.ref_name }}-linux-x86_64.tar.gz` |
            | Linux | ARM64 | `lance-${{ github.ref_name }}-linux-aarch64.tar.gz` |
            | macOS | Intel | `lance-${{ github.ref_name }}-macos-x86_64.tar.gz` |
            | macOS | Apple Silicon | `lance-${{ github.ref_name }}-macos-aarch64.tar.gz` |
            
            **Contents:** `lance` (server), `lnc` (CLI), `LICENSE`
            
            #### Windows Users
            
            There is no native Windows binary. The `lnc` CLI is designed to work directly with the server and has Linux-specific dependencies (io_uring). Windows users should:
            
            1. **WSL2 (Recommended)**: Download the Linux x86_64 binary and run it within WSL2
            2. **Docker**: Use the Docker image for server deployment
            3. **Rust Library**: For application integration, use `cargo add lnc-client` (cross-platform)
            
            ### Docker
            
            ```bash
            docker pull nitecon/lance:${{ github.ref_name }}
            ```
            
            ### Rust Client Library
            
            ```bash
            cargo add lnc-client
            ```
            
            ### Verify Checksums
            
            ```bash
            sha256sum -c SHA256SUMS.txt
            ```
            
            ### Requirements
            
            - **Linux**: Kernel 5.15+ for io_uring support
            - **macOS**: macOS 11+ (server builds but io_uring features disabled)
            - **Windows**: Use WSL2 with Linux binary, or Docker
            
            See [documentation](https://github.com/${{ github.repository }}/blob/main/docs/Architecture.md) for deployment guide.
