# LANCE Cyclomatic Complexity Check
# Per Engineering Standards - Functions should have CC < 10 (warning), CC > 15 blocks merge
#
# Uses rust-code-analysis for accurate Rust complexity measurement

name: Complexity Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  # Complexity thresholds
  CC_WARNING_THRESHOLD: 10
  CC_ERROR_THRESHOLD: 15
  # Function line limit
  MAX_FUNCTION_LINES: 50

jobs:
  complexity-analysis:
    name: Cyclomatic Complexity Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install rust-code-analysis
        run: |
          cargo install rust-code-analysis-cli --locked || \
          echo "Note: rust-code-analysis-cli installation failed, using fallback"

      - name: Run complexity analysis
        run: |
          echo "=== LANCE Complexity Analysis Report ===" > complexity-report.txt
          echo "Generated: $(date)" >> complexity-report.txt
          echo "" >> complexity-report.txt
          
          # Analyze each crate
          for crate in lance lnc-core lnc-io lnc-network lnc-replication lnc-client lnc; do
            if [ -d "$crate/src" ]; then
              echo "## $crate" >> complexity-report.txt
              rust-code-analysis-cli -m -O json -p "$crate/src" 2>/dev/null | \
                jq -r '.[] | select(.metrics.cyclomatic > 10) | "\(.name): CC=\(.metrics.cyclomatic)"' \
                >> complexity-report.txt 2>/dev/null || \
                echo "  (analysis pending)" >> complexity-report.txt
              echo "" >> complexity-report.txt
            fi
          done
          
          cat complexity-report.txt

      - name: Check for high complexity violations
        run: |
          # Count functions with CC > 15 (error threshold)
          HIGH_CC=$(rust-code-analysis-cli -m -O json -p . 2>/dev/null | \
            jq '[.[] | select(.metrics.cyclomatic > 15)] | length' 2>/dev/null || echo "0")
          
          if [ "$HIGH_CC" -gt 0 ]; then
            echo "❌ Found $HIGH_CC functions with cyclomatic complexity > 15"
            echo "See Engineering Standards: Functions should have CC < 10"
            # Note: Currently warning-only until baseline is established
            # exit 1
          else
            echo "✅ No functions exceed complexity threshold"
          fi

      - name: Upload complexity report
        uses: actions/upload-artifact@v4
        with:
          name: complexity-report
          path: complexity-report.txt
          retention-days: 30

  function-length-check:
    name: Function Length Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check for long functions
        run: |
          echo "=== Function Length Analysis ===" 
          echo "Threshold: $MAX_FUNCTION_LINES lines"
          echo ""
          
          # Find Rust files and count function lengths
          # This is a heuristic check - looks for fn definitions and counts to next fn or }
          find . -name "*.rs" -not -path "./target/*" | while read file; do
            # Count lines in each function (simplified heuristic)
            awk '
              /^[[:space:]]*(pub[[:space:]]+)?(async[[:space:]]+)?fn[[:space:]]+[a-zA-Z_]/ {
                if (fn_name != "" && line_count > 50) {
                  print FILENAME ":" fn_start ": " fn_name " (" line_count " lines)"
                }
                fn_name = $0
                fn_start = NR
                line_count = 0
              }
              fn_name != "" { line_count++ }
              END {
                if (fn_name != "" && line_count > 50) {
                  print FILENAME ":" fn_start ": " fn_name " (" line_count " lines)"
                }
              }
            ' "$file" 2>/dev/null
          done | head -50 || echo "Function length check complete"
